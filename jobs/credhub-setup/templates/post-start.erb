#!/usr/bin/env bash

set -o errexit -o nounset -o xtrace

PATH="${PATH}:$(echo /var/vcap/packages/cf-cli-*-linux/bin)"
export PATH

printf "Waiting for cloud controller to be available at %s...\n" "${CF_API}"
until curl --insecure --fail --silent --head "${CF_API}/v2/info"; do
    sleep 10
done

# TODO: use cc('public_tls.ca_cert') somehow
cf api --skip-ssl-validation "${CF_API}"

cf auth --client-credentials

sec_group_file="$(mktemp)"
trap "rm -f '${sec_group_file}'" EXIT

printf "Creating security group definition:\n"
tee "${sec_group_file}" <<EOF
[{
    "protocol": "tcp",
    "description": "Allow traffic to ${POD_NAME}",
    "destination": "${POD_IP}/32",
    "ports": "${POD_PORTS}"
}]
EOF

sec_group_name="internal-${POD_NAME}"

printf "Looking for existing security group %s; failure is normal.\n" "${sec_group_name}"
if ! cf security-group "${sec_group_name}"; then
    printf "Creating new security group %s.\n" "${sec_group_name}"
    cf create-security-group "${sec_group_name}" "${sec_group_file}"
    cf bind-staging-security-group "${sec_group_name}"
    cf bind-running-security-group "${sec_group_name}"
else
    printf "Updating existing security group %s.\n" "${sec_group_name}"
    cf update-security-group "${sec_group_name}" "${sec_group_file}"
fi
